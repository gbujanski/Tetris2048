var p=Object.defineProperty;var m=(n,t,e)=>t in n?p(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var l=(n,t,e)=>m(n,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class h{constructor(t=0){l(this,"_value");this._value=t}get bgColor(){return this.getTileData(this.value).bgColor}get textColor(){return this.getTileData(this.value).textColor}get displayValue(){return this.getTileData(this.value).displayValue}get value(){return this._value}set value(t){t!==this._value&&(this._value=t)}toJson(){return{value:this.value}}static fromJson(t){return new h(t.value)}getTileData(t){return t===0?{bgColor:"#030303",textColor:"#000",displayValue:""}:t<4?{bgColor:"#776e65",textColor:"#000",displayValue:"2"}:t<8?{bgColor:"#eee4da",textColor:"#000",displayValue:"4"}:t<16?{bgColor:"#ede0c8",textColor:"#000",displayValue:"8"}:t<32?{bgColor:"#f2b179",textColor:"#000",displayValue:"16"}:t<64?{bgColor:"#f59563",textColor:"#000",displayValue:"32"}:t<128?{bgColor:"#f67c5f",textColor:"#000",displayValue:"64"}:t<256?{bgColor:"#f65e3b",textColor:"#000",displayValue:"128"}:t<512?{bgColor:"#edcf72",textColor:"#000",displayValue:"256"}:t<1024?{bgColor:"#edcc61",textColor:"#000",displayValue:"512"}:t<2048?{bgColor:"#edc850",textColor:"#000",displayValue:"1024"}:t<4096?{bgColor:"#e8b026",textColor:"#000",displayValue:"2048"}:t<8192?{bgColor:"#a86ae4",textColor:"#000",displayValue:"4096"}:t<16384?{bgColor:"#6b4fc4",textColor:"#ffffff",displayValue:"8192"}:t<32768?{bgColor:"#3c3a32",textColor:"#ffffff",displayValue:"16k"}:t<65536?{bgColor:"#2b2b2b",textColor:"#ffffff",displayValue:"32k"}:t<131072?{bgColor:"#1e1b2e",textColor:"#ffffff",displayValue:"64k"}:t<262144?{bgColor:"#291b1b",textColor:"#ffffff",displayValue:"128k"}:t<524288?{bgColor:"#1e2d1e",textColor:"#ffffff",displayValue:"256k"}:t<1048576?{bgColor:"#2e1e2d",textColor:"#ffffff",displayValue:"512k"}:t<2097152?{bgColor:"#1c1c2e",textColor:"#ffffff",displayValue:"1M"}:t<4194304?{bgColor:"#2e2c1c",textColor:"#ffffff",displayValue:"2M"}:t<8388608?{bgColor:"#1f1f1f",textColor:"#ffffff",displayValue:"4M"}:t<16777216?{bgColor:"#181818",textColor:"#ffffff",displayValue:"8M"}:t<33554432?{bgColor:"#141414",textColor:"#ffffff",displayValue:"16M"}:t<67108864?{bgColor:"#101010",textColor:"#ffffff",displayValue:"32M"}:t<134217728?{bgColor:"#0d0d0d",textColor:"#ffffff",displayValue:"64M"}:t<268435456?{bgColor:"#0a0a0a",textColor:"#ffffff",displayValue:"128M"}:t<536870912?{bgColor:"#070707",textColor:"#ffffff",displayValue:"256M"}:t<1073741824?{bgColor:"#050505",textColor:"#ffffff",displayValue:"512M"}:{bgColor:"#030303",textColor:"#ffffff",displayValue:""}}}const a={Add:"add",Move:"move",Merge:"merge"},u=class u{constructor(){l(this,"state");l(this,"listeners");this.state=new Map,this.listeners=new Map,this.loadStateFromLocalStorage()}static getInstance(){return u._instance||(u._instance=new u),u._instance}set(t,e){const o=this.state.get(t);this.state.set(t,e),this.saveStateToLocalStorage();const s=this.listeners.get(t);s&&s.forEach(r=>r(e,o))}get(t){return this.state.get(t)}has(t){return this.state.has(t)}delete(t){const e=this.state.delete(t);return this.saveStateToLocalStorage(),this.listeners.delete(t),e}clear(){this.state.clear(),this.listeners.clear(),localStorage.removeItem("appState")}subscribe(t,e){this.listeners.has(t)||this.listeners.set(t,new Set);const o=this.listeners.get(t);return o.add(e),()=>o.delete(e)}saveStateToLocalStorage(){localStorage.setItem("appState",JSON.stringify(Array.from(this.state.entries())))}loadStateFromLocalStorage(){const t=localStorage.getItem("appState");t&&(this.state=new Map(JSON.parse(t)))}};l(u,"_instance");let d=u;class C{constructor(t,e){l(this,"state",d.getInstance());l(this,"_tiles");l(this,"boardActions",[]);l(this,"tilesToCheckInNextStep",[]);l(this,"colsToUpdate",[]);this.state.has("board")?this._tiles=this.generateBoardFromState():this._tiles=this.generateEmptyBoard(t,e)}get tiles(){return this._tiles}reset(){this._tiles.forEach(t=>t.forEach(e=>e.value=0)),this.state.set("board",this._tiles.map(t=>t.map(e=>e.value)))}addTile(t,e){const{row:o,col:s}=t;if(this.boardActions=[],o<0||o>=this._tiles.length||s<0||s>=this._tiles[o].length)throw new Error("Index out of bounds");if(e<0)throw new Error("Value cannot be negative");const r=this.getIndexOfLastFilledTileInColumn(s);return r===-1?this.updateTileData({action:a.Add,to:{row:0,col:s},value:e}):r===this._tiles.length-1?this._tiles[r][s].value==e&&this.updateTileData({action:a.Merge,from:{row:r,col:s},to:{row:r,col:s},value:e*2}):this.updateTileData({action:a.Add,to:{row:r+1,col:s},value:e}),this.checkForMerge(),this.state.set("board",this._tiles.map(i=>i.map(f=>f.value))),this.boardActions}isTopTileHaveSameValue(t){const{row:e,col:o}=t;return e===0?!1:this._tiles[e-1][o].value===this._tiles[e][o].value}isLeftTileHaveSameValue(t){const{row:e,col:o}=t;return o===0?!1:this._tiles[e][o-1].value===this._tiles[e][o].value}isRightTileHaveSameValue(t){const{row:e,col:o}=t;return o===this._tiles[e].length-1?!1:this._tiles[e][o+1].value===this._tiles[e][o].value}isBottomTileHaveSameValue(t){const{row:e,col:o}=t;return e===this._tiles.length-1?!1:this._tiles[e+1][o].value===this._tiles[e][o].value}getIndexOfLastFilledTileInColumn(t){for(let e=this._tiles.length-1;e>=0;e--)if(this._tiles[e][t].value!==0)return e;return-1}updateTileData(t){this.boardActions.push({...t}),t.action===a.Move&&(this._tiles[t.to.row][t.to.col].value=this._tiles[t.from.row][t.from.col].value),t.action!==a.Move&&(this._tiles[t.to.row][t.to.col].value=t.value),t.action!==a.Add&&(this._tiles[t.from.row][t.from.col].value=0),this.tilesToCheckInNextStep.push(t.to)}checkForMerge(){if(this.tilesToCheckInNextStep.length===0)return;const t=[...this.tilesToCheckInNextStep];this.tilesToCheckInNextStep=[],t.forEach(e=>{const{row:o,col:s}=e;this._tiles[o][s].value!==0&&(this.isTopTileHaveSameValue(e)?(this.updateTileData({action:a.Merge,to:{row:o-1,col:s},value:this._tiles[o][s].value*2,from:e}),this.colsToUpdate.push(s)):this.isLeftTileHaveSameValue(e)?(this.updateTileData({action:a.Merge,to:{row:o,col:s-1},value:this._tiles[o][s].value*2,from:e}),this.colsToUpdate.push(s)):this.isRightTileHaveSameValue(e)?(this.updateTileData({action:a.Merge,to:e,value:this._tiles[o][s].value*2,from:{row:o,col:s+1}}),this.colsToUpdate.push(s+1)):this.isBottomTileHaveSameValue(e)&&(this.updateTileData({action:a.Merge,to:{row:o+1,col:s},value:this._tiles[o][s].value*2,from:e}),this.colsToUpdate.push(s)))}),this.moveTileIfTopTileIsEmpty()}moveTileIfTopTileIsEmpty(){if(this.colsToUpdate.length===0){this.checkForMerge();return}this.colsToUpdate.forEach(t=>{this._tiles.forEach((e,o)=>{o>0&&this._tiles[o-1][t].value===0&&this.updateTileData({action:a.Move,to:{row:o-1,col:t},from:{row:o,col:t}})})}),this.colsToUpdate=[],this.checkForMerge()}generateBoardFromState(){return this.state.get("board").map(e=>e.map(o=>new h(o)))}generateEmptyBoard(t,e){const o=Array.from({length:e},()=>Array.from({length:t},()=>new h(0)));return this.state.set("board",o.map(s=>s.map(r=>r.value))),o}}class b{constructor(t,e){l(this,"_board");l(this,"_boardEl");this._board=t,this._boardEl=e,this.generateBoardStructure()}async updateBoard(t){for(const e of t)switch(e.action){case a.Add:this.addTile(e);break;case a.Move:await this.editTile(e);break;case a.Merge:await this.editTile(e);break}}reset(){this._boardEl.innerHTML="",this.generateBoardStructure()}addTile(t){const e=this._boardEl.children[t.to.row].children[t.to.col],o=new h(t.value);e.textContent=o.displayValue,e.style.backgroundColor=o.bgColor,e.style.color=o.textColor,e.dataset.value=o.value.toString()}async editTile(t){const e=this._boardEl.children[t.from.row].children[t.from.col],o=this._boardEl.children[t.to.row].children[t.to.col],s=e.dataset.value?parseInt(e.dataset.value):0;if(e.textContent!==""){const i=e.cloneNode(!0),f=o.getBoundingClientRect(),c=e.getBoundingClientRect();i.style.left=`${c.left}px`,i.style.top=`${c.top}px`,i.style.position="absolute",i.style.zIndex="1000",i.style.transition="left 0.3s ease, top 0.3s ease",this._boardEl.appendChild(i),i.getBoundingClientRect(),i.style.left=`${f.left}px`,i.style.top=`${f.top}px`,e.textContent="",e.style.backgroundColor="",await this.sleep(300),i.remove()}const r=new h(t.action===a.Move?s:t.value);o.textContent=r.displayValue,o.dataset.value=r.value.toString(),o.textContent&&(o.style.backgroundColor=r.bgColor,o.style.color=r.textColor)}generateBoardStructure(){this._board.tiles.forEach((t,e)=>{const o=document.createElement("div");o.className="row",o.dataset.row=e.toString(),t.forEach((s,r)=>{const i=document.createElement("div");if(i.className="tile",i.dataset.col=r.toString(),i.dataset.value=s.value.toString(),s.value!==0){const f=new h(s.value);i.textContent=f.displayValue,i.style.backgroundColor=f.bgColor,i.style.color=f.textColor}o.appendChild(i)}),this._boardEl.appendChild(o)})}async sleep(t){return new Promise(e=>setTimeout(e,t))}}class T{constructor(){l(this,"nextTileEl");l(this,"state",d.getInstance());this.nextTileEl=document.getElementById("next-tile"),this.updateNextTileDisplay(),this.subscribeForFutureChanges()}subscribeForFutureChanges(){this.state.subscribe("board",()=>{this.updateNextTileDisplay()})}updateNextTileDisplay(){const t=this.getNextTileValue();this.state.set("nextTile",t);const e=new h(t);this.nextTileEl.textContent=e.displayValue,this.nextTileEl.style.backgroundColor=e.bgColor,this.nextTileEl.style.color=e.textColor}getNextTileValue(){const t=this.getLog2FromHighestTile(),e=this.generateNextRandomPowerOfTwo(t);return Math.pow(2,e)}getLog2FromHighestTile(){const t=this.state.get("board"),e=Math.max(...t.flat());return Math.log2(e)}generateNextRandomPowerOfTwo(t){let e;return t-5<-3?e=1:t-5<0?e=Math.ceil(Math.random()*2):e=Math.ceil(Math.random()*(t-4)),e}}class y{constructor(t,e){l(this,"board");l(this,"renderer");l(this,"state",d.getInstance());this.board=t,this.renderer=e,this.subscribeForFutureChanges(),this.onResetButtonClick()}reset(){this.board.reset(),this.renderer.reset()}addTile(t,e){const o=this.board.addTile(t,e);this.renderer.updateBoard(o)}subscribeForFutureChanges(){this.state.subscribe("dropTarget",t=>{var r;const e=t.dataset.col?parseInt(t.dataset.col):0,o=(r=t.parentElement)!=null&&r.dataset.row?parseInt(t.parentElement.dataset.row):0,s=parseInt(this.state.get("nextTile"));this.addTile({row:o,col:e},s)})}onResetButtonClick(){document.getElementById("reset-btn").addEventListener("click",()=>{this.reset()})}}class x{constructor(){l(this,"state",d.getInstance());l(this,"dragEl");l(this,"ghostEl",null);l(this,"onPointerDown",t=>{t.preventDefault(),t.button===0&&(this.state.set("dragging",!0),this.createGhostElement(t.clientX,t.clientY),document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerup",this.onPointerUp))});l(this,"onPointerMove",t=>{!this.state.get("dragging")||!this.ghostEl||this.setGhostElementPosition(t.clientX,t.clientY)});l(this,"onPointerUp",t=>{if(!this.state.get("dragging"))return;this.state.set("dragging",!1);const e=document.elementFromPoint(t.clientX,t.clientY),o=e==null?void 0:e.closest(".tile");o&&this.state.set("dropTarget",o),this.ghostEl.remove(),this.ghostEl=null,document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerup",this.onPointerUp)});this.dragEl=document.getElementById("next-tile"),this.dragEl.style.touchAction="none",this.dragEl.addEventListener("pointerdown",this.onPointerDown)}createGhostElement(t,e){this.ghostEl||(this.ghostEl=this.dragEl.cloneNode(!0),this.ghostEl.classList.add("dragging"),this.setGhostElementPosition(t,e),document.body.appendChild(this.ghostEl))}setGhostElementPosition(t,e){this.ghostEl&&(this.ghostEl.style.left=`${t-50}px`,this.ghostEl.style.top=`${e-50}px`)}}const w=document.getElementById("board"),E=5,v=8,g=new C(E,v),V=new b(g,w);new y(g,V);new T;new x;
